<!DOCTYPE html>
<html class="x-admin-sm">

    <head>
        <meta charset="UTF-8">
        <title>欢迎页面-MyGO2.0</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
        <link rel="stylesheet" href="{{ url_for('static', filename='/css/font.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='/css/xadmin.css') }}">
        <script src="/static/lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="/static/js/xadmin.js"></script>
    </head>

    <body>
        <div class="x-nav">
            <span class="layui-breadcrumb">
                <a href="">首页</a>
                <a href="">种植管理</a>
            </span>
            <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" onclick="location.reload()" title="刷新">
                <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
            </a>
        </div>
        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-body ">
                                <div class="layui-input-inline layui-show-xs-block">
                                    <input class="layui-input" placeholder="作物名字" name="crop_name" id="crop_name"></div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <input class="layui-input" placeholder="种植农田" name="field_name" id="field_name"></div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <input class="layui-input" placeholder="种植规模（亩）" name="size" id="size" type="number"></div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <input class="layui-input" placeholder="纬度" name="latitude" id="latitude" type="number"></div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <input class="layui-input" placeholder="经度" name="longitude" id="longitude" type="number"></div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <input class="layui-input" placeholder="种植日期" name="plant_date" id="plant_date" type="date"></div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <input class="layui-input" placeholder="作物状态" name="crop_state" id="crop_state"></div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <input class="layui-input" placeholder="浇水量（升）" name="irrigation" id="irrigation" type="number" step="any"></div>
                                <div class="layui-input-inline layui-show-xs-block">
                                    <button class="layui-btn" lay-submit="" lay-filter="search" id="search">
                                        <i class="layui-icon">&#xe615;</i></button>
                                </div>
                        </div>
                        <div class="layui-card-header">
                            <button class="layui-btn" onclick="member_add()" id="add">
                                <i class="layui-icon"></i>添加</button></div>
                        <div class="layui-card-body">
                            <table id="jsonTable" lay-filter="jsonTableFilter"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        layui.use(['laydate', 'table', 'layer'], function() {
        var laydate = layui.laydate;
        var table = layui.table;
        var layer = layui.layer;

        // 执行一个laydate实例
        laydate.render({
            elem: '#start' // 指定元素
        });

        // 执行一个laydate实例
        laydate.render({
            elem: '#end' // 指定元素
        });

        // 初始化表格
        function initTable(data) {
            var role = '{{role}}';
            var user_id = '{{user_id}}';
            var cols = [
                {field: 'crop_name', title: '作物名字', width: 120},
                {field: 'field_name', title: '种植农田', width: 180, sort: true},
                {field: 'size', title: '种植规模（亩）', width: 180, sort: true},
                {field: 'latitude', title: '纬度', width: 180, sort: true},
                {field: 'longitude', title: '经度', width: 180, sort: true},
                {field: 'plant_date', title: '种植日期', width: 180, sort: true},
                {field: 'crop_state', title: '作物状态', width: 180, sort: true},
                {field: 'irrigation', title: '浇水量（升）', width: 180, sort: true},
                {title: '详情', width: 180, templet: function(d){
                    return '<div class="td-manage">' +
                            '<a title="详情" onclick="member_info(this,\'' + d.crop_id + '\',\'' + d.field_id + '\')" href="javascript:;">' +
                            '<i class="layui-icon">&#xe63c;</i></a>' +
                            '</div>';
                }}
            ];
            if(role === "admin" || role === "plant"){
                cols.push(
                    {title: '成熟', width: 180, templet: function(d){
                        return '<div class="td-manage">' +
                               '<a title="成熟" onclick="member_mature(this,\'' + d.crop_id + '\',\'' + d.field_id + '\',\'' + d.plant_date + '\',\'' + user_id + '\',\'' + role + '\')" href="javascript:;">' +
                               '<i class="layui-icon">&#xe63c;</i></a>' +
                               '</div>';
                    }},
                    {title: '浇水', width: 180, templet: function(d){
                        return '<div class="td-manage">' +
                               '<a title="浇水" onclick="member_water(this,\'' + d.crop_id + '\',\'' + d.field_id + '\',\'' + user_id + '\',\'' + role + '\')" href="javascript:;">' +
                               '<i class="layui-icon">&#xe63c;</i></a>' +
                               '</div>';
                    }},
                    {title: '删除', width: 180, templet: function(d){
                        return '<div class="td-manage">' +
                               '<a title="删除" onclick="member_del(this,\'' + d.crop_id + '\',\'' + d.field_id + '\',\'' + user_id + '\',\'' + role + '\')" href="javascript:;">' +
                               '<i class="layui-icon">&#xe640;</i></a>' +
                               '</div>';
                    }}
                );
            }
            if(role === "admin" || role === "harvest"){
                cols.push(
                    {title: '收获量（千克）', width: 180, templet: function(d){
                        return '<div class="td-manage">' +
                            '<input type="text" id="harvest_' + d.crop_id + '_' + d.field_id + '" name="harvest" placeholder="收获量">' +
                            '</div>';
                    }},
                    {title: '收获', width: 180, templet: function(d){
                        return '<div class="td-manage">' +
                               '<a title="修改" onclick="member_harvest(this,\'' + d.crop_id + '\',\'' + d.field_id + '\',\'' + d.crop_state + '\',\'' + user_id + '\',\'' + role + '\')" href="javascript:;">' +
                               '<i class="layui-icon">&#xe63c;</i></a>' +
                               '</div>';
                    }}
                );
            }


            table.render({
                elem: '#jsonTable',
                cols: [cols],
                data: data, // 数据接口
                page: true // 开启分页
            });
        }

        window.member_info = function(obj, crop_id, field_id){
            xadmin.open('种植信息','./plant_info.html?crop_id=' + crop_id + '&field_id=' + field_id);
        }

        window.member_add = function(){
            var index = xadmin.open('添加种植信息','./plant_add.html?user_id=' + '{{user_id}}' + '&role=' + '{{role}}',800,600);
        }

        window.member_mature = function(obj, crop_id, field_id, plant_data, user_id, role) {
            // 打开新的网页，传递ID参数

            var plantDate = new Date(plant_data);
            var currentDate = new Date();

            var diffTime = Math.abs(currentDate - plantDate);
            var diffDay = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            var queryParams = {
                crop_id: crop_id
            };

            var matureParams = {
                crop_id: crop_id,
                field_id: field_id,
                user_id: user_id,
                role: role,
                crop_state: 'mature'
            };

            // 刷新表格
            fetch('./search_crop',{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(queryParams)
            })
                .then(function(response) {
                    return response.json();
                })
                .then(function(jsonData) {
                    if(jsonData.crop_list[0].birth_cycle > diffDay){
                        layer.msg('生长实践少于生长周期', {icon: 5});
                    }
                    else{
                        fetch('./change_plant',{
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(matureParams)
                        })
                        .then(function(response){
                            return response.json();
                        })
                        .then(function(data){
                            if(data.response === 'success'){
                                layer.msg('作物已成熟!', {icon: 1});
                                location.reload();
                            }
                            else{
                                layer.msg('操作失败', {icon: 5});
                            }
                        })
                        .catch(function(error) {
                            layer.msg('请求失败', {icon: 5});
                        });
                    }
                })
                .catch(function(error) {
                    layer.msg('数据加载失败', {icon: 5});
                });
                console.log('弹窗已关闭');
        }

        // 删除成员
        window.member_del = function(obj, crop_id, field_id, user_id, role) {
            layer.confirm('确认要删除吗？', function(index) {
                var queryParams = {
                    crop_id: crop_id,
                    field_id: field_id,
                    user_id: user_id,
                    role: role,
                };
                // 发送删除请求
                fetch('./del_plant',{
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(queryParams)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(jsonData) {
                //返回success
                    if (jsonData.response === 'success') {
                        // 删除成功
                        layer.msg('已删除!', {icon: 1});
                        // 刷新表格
                        location.reload();
                    } else {
                        // 删除失败
                        layer.msg('删除失败', {icon: 5});
                    }
                })
                .catch(function(error) {
                    layer.msg('请求失败', {icon: 5});
                });
                layer.close(index);
            });
        }

        window.member_harvest = function(obj, crop_id, field_id, crop_state, user_id, role){
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, '0');
            var mm = String(today.getMonth() + 1).padStart(2, '0');
            var yyyy = today.getFullYear();

            today = yyyy + '-' + mm + '-' + dd;
            
            var harvest_weight = document.getElementById('harvest_' + crop_id + '_' + field_id).value;

            if(harvest_weight === ''){
                layer.msg('收获量不能为零', {icon: 5});
                return;
            }

            console.log(harvest_weight);

            var harvestParams = {
                crop_id: crop_id,
                field_id: field_id,
                user_id: user_id,
                role: role,
                harvest_date: today,
                harvest_weight: harvest_weight
            };

            if(crop_state === 'mature'){
                fetch('./add_harvest',{
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(harvestParams)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(jsonData) {
                //返回success
                    if (jsonData.response === 'success') {
                        // 删除成功
                        layer.msg('已收获!', {icon: 1});
                        // 刷新表格
                        location.reload();
                    } else {
                        // 删除失败
                        layer.msg('收获失败', {icon: 5});
                    }
                })
                .catch(function(error) {
                    layer.msg('请求失败', {icon: 5});
                });
            }
            else{
                layer.msg('作物未成熟或者已收获', {icon: 5});
            }
        }

        // 页面加载完毕自动获取全部数据
        fetch('./search_plant',{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(jsonData) {
            initTable(jsonData.plant_list); // 展示数据
        })
        .catch(function(error) {
            layer.msg('数据加载失败', {icon: 5});
        });

        document.addEventListener('DOMContentLoaded', function(){
            var role = '{{role}}';

            if(role === 'admin' || role === 'plant'){
                document.getElementById("add").style.display = 'block';
            }
            else{
                document.getElementById("add").style.display = 'none';
            }
        })


        // 绑定搜索按钮的点击事件
        document.getElementById('search').addEventListener('click', function() {

            var crop_name = document.getElementById('crop_name').value;
            var field_name = document.getElementById('field_name').value;
            var plant_date = document.getElementById('plant_date').value;
            var crop_state = document.getElementById('crop_state').value;
            var irrigation = document.getElementById('irrigation').value;
            var size = document.getElementById('size').value;
            var longitude = document.getElementById('longitude').value;
            var latitude = document.getElementById('latitude').value;

            if (!crop_name && !field_name && !plant_date && !crop_state && !irrigation && !size && !longitude && !latitude) {
                layer.msg('请输入至少一个搜索条件', {icon: 5});
                location.reload();
                return; // 如果所有数据为空，则不执行后续操作
            }

            // 构建查询参数
            var queryParams = {
                crop_name: crop_name,
                field_name: field_name,
                plant_date: plant_date,
                crop_state: crop_state,
                irrigation: irrigation,
                size: size,
                longitude: longitude,
                latitude: latitude
            };

            // 发送带查询参数的请求
            fetch('./plant_list',{
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(queryParams)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(jsonData) {
                initTable(jsonData.plant_list); // 使用搜索结果更新表格
            })
            .catch(function(error) {
                layer.msg('搜索失败', {icon: 5});
            });
        });
    });

    </script>

</html>