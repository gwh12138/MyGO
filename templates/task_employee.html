<!DOCTYPE html>
<html class="x-admin-sm">

    <head>
        <meta charset="UTF-8">
        <title>欢迎页面-MyGO2.0</title>
        <meta name="renderer" content="webkit">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi" />
        <link rel="stylesheet" href="{{ url_for('static', filename='/css/font.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='/css/xadmin.css') }}">
        <link href="//cdn.staticfile.net/layui/2.9.13/css/layui.css" rel="stylesheet">
        <script src="/static/lib/layui/layui.js" charset="utf-8"></script>
        <script type="text/javascript" src="/static/js/xadmin.js"></script>
    </head>

    <body>
        <div class="x-nav">
            <span class="layui-breadcrumb">
                <a href="">首页</a>
                <a href="">任务管理</a>
            </span>
            <a class="layui-btn layui-btn-small" style="line-height:1.6em;margin-top:3px;float:right" onclick="location.reload()" title="刷新">
                <i class="layui-icon layui-icon-refresh" style="line-height:30px"></i>
            </a>
        </div>
        <div class="layui-fluid">
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-body ">
                            <div class="layui-input-inline layui-show-xs-block">
                                <input class="layui-input" placeholder="对应农田" name="field_name" id="field_name"></div>
                            <div class="layui-input-inline layui-show-xs-block">
                                <input class="layui-input" placeholder="对应作物" name="crop_name" id="crop_name"></div>
                            <div class="layui-input-inline layui-show-xs-block">
                                <input class="layui-input" placeholder="任务状态" name="task_state" id="task_state"></div>


                                <div class="layui-input-inline layui-show-xs-block">
                                    <button class="layui-btn" lay-submit="" lay-filter="search" id="search">
                                        <i class="layui-icon">&#xe615;</i></button>
                                </div>
                        </div>
                        <form class="layui-form" action="">
                        <div class="layui-form-item">
                            <div class="layui-input-block">
                              <input type="checkbox" name="switch" id="switch" lay-skin="switch" lay-filter="switchTest" title="我的任务|全部任务">
                            </div>
                        </div>
                        </form>
                        <div class="layui-card-body">
                            <table id="jsonTable" lay-filter="jsonTableFilter"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script src="//cdn.staticfile.net/layui/2.9.13/layui.js"></script>
    <script>
        layui.use(['laydate', 'table', 'layer', 'form'], function() {
        var laydate = layui.laydate;
        var table = layui.table;
        var layer = layui.layer;
        var form = layui.form;

        form.render('checkbox');

        // 执行一个laydate实例
        laydate.render({
            elem: '#start' // 指定元素
        });

        // 执行一个laydate实例
        laydate.render({
            elem: '#end' // 指定元素
        });

        function initTable(data) {
            var user_id = '{{user_id}}';
            var cols = [
                {field: 'operate', title: '操作', width: 120},
                {field: 'field_name', title: '对应农田', width: 120, sort: true},
                {field: 'crop_name', title: '对应作物', width: 120, sort: true},
                {field: 'task_state', title: '任务状态', width: 120, sort: true},
                {title: '详情', width: 180, templet: function(d){
                    return '<div class="td-manage">' +
                            '<a title="详情" onclick="member_info(this,\'' + d.task_id + '\')" href="javascript:;">' +
                            '<i class="layui-icon">&#xe63c;</i></a>' +
                            '</div>';
                }},
                {title: '接受任务', width: 180, templet: function(d){
                    return '<div class="td-manage">' +
                            '<a title="接受任务" onclick="member_change(this,\'' + d.task_id + '\',\'' + d.task_state + '\',\'' + user_id + '\')" href="javascript:;">' +
                            '<i class="layui-icon">&#xe63c;</i></a>' +
                            '</div>';
                }}
            ];


            table.render({
                elem: '#jsonTable',
                cols: [cols],
                data: data, // 数据接口
                page: true // 开启分页
            });
        }

        fetch('./search_task',{
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                operate: '{{role}}' === 'plant' ? '种植' : '收获',
            })
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(jsonData) {
            initTable(jsonData.task_list); // 展示数据
        })
        .catch(function(error) {
            layer.msg('数据加载失败', {icon: 5});
        });

        window.member_info = function(obj, task_id){
            xadmin.open('任务详情信息','./task_info.html?task_id=' + task_id);
        }

        window.member_change = function(obj, task_id, task_state, user_id) {
            // 打开新的网页，传递ID参数
            var changeParams = {
                user_id: user_id,
                task_id: task_id,
                task_state: '已接收'
            };

            if(task_state === '未接收'){
                // 发送删除请求
                fetch('./change_task',{
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(changeParams)
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(jsonData) {
                //返回success
                    if (jsonData.response === 'success') {
                        // 删除成功
                        layer.msg('已接收!', {icon: 1});
                        // 刷新表格
                        location.reload();
                    } else {
                        // 删除失败
                        layer.msg('已经被接收', {icon: 5});
                    }
                })
                .catch(function(error) {
                    layer.msg('请求失败', {icon: 5});
                });
            }
            else{
                layer.msg('已经被接收', {icon: 5});
            }
        }
        var switchElement = document.querySelector('#switch');
        
        function search() {
            var switchElement = document.querySelector('#switch');
            var field_name = document.getElementById('field_name').value;
            var crop_name = document.getElementById('crop_name').value;
            var task_state = document.getElementById('task_state').value;
            var user_id = '{{user_id}}';

            if('{{role}}' === 'plant'){
                var operate = '种植';
            }
            else{
                var operate = '收获';
            }

            if(switchElement.checked) {
                // 当开关打开时执行的搜索
                console.log('执行打开时的搜索');
                if (!field_name && !crop_name && !task_state && !user_id) {
                    layer.msg('请输入至少一个搜索条件', {icon: 5});
                    location.reload();
                    return; // 如果所有数据为空，则不执行后续操作
                }
                var queryParams = {
                    field_name: field_name,
                    crop_name: crop_name,
                    task_state: task_state,
                    operate: operate,
                    user_id: user_id
                };
            } else {
                // 当开关关闭时执行的搜索
                console.log('执行关闭时的搜索');
                if (!field_name && !operate && !crop_name && !task_state) {
                    layer.msg('请输入至少一个搜索条件', {icon: 5});
                    location.reload();
                    return; // 如果所有数据为空，则不执行后续操作
                }

                var queryParams = {
                    field_name: field_name,
                    crop_name: crop_name,
                    task_state: task_state,
                    operate: operate
                };
            }

            // 发送带查询参数的请求
            fetch('./search_task', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(queryParams)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(jsonData) {
                initTable(jsonData.task_list); // 使用搜索结果更新表格
            })
            .catch(function(error) {
                layer.msg('搜索失败', {icon: 5});
            });
        }

        form.on('switch(switchTest)', function(data){
            search();
        });


        // 绑定搜索按钮的点击事件
        document.getElementById('search').addEventListener('click', function() {
            search();
        });
    });

    </script>

</html>